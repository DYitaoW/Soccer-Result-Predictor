<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Soccer Predictor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    /* Dark Mode Variables & Overrides */
    :root {
      --bg-color: #ffffff;
      --text-color: #333333;
      --card-bg: #ffffff;
      --card-border: #ddd;
      --accent-color: #d32f2f;
    }
    body.dark-mode {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --card-border: #333;
      --accent-color: #ff5252;
    }
    /* Dark Mode Table Row Colors */
    body.dark-mode .table-first { background-color: rgba(255, 215, 0, 0.15) !important; }
    body.dark-mode .table-promo-blue { background-color: rgba(33, 150, 243, 0.15) !important; }
    body.dark-mode .table-playoff-purple { background-color: rgba(156, 39, 176, 0.15) !important; }
    body.dark-mode .table-playoff-orange { background-color: rgba(255, 152, 0, 0.15) !important; }
    body.dark-mode .table-second-pink { background-color: rgba(233, 30, 99, 0.15) !important; }
    body.dark-mode .table-bottom { background-color: rgba(244, 67, 54, 0.15) !important; }

    body { background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
    .card { background-color: var(--card-bg); border-color: var(--card-border); color: var(--text-color); }
    .match-card { background-color: var(--card-bg); border-color: var(--card-border); color: var(--text-color); }
    .mls-cup-card { background-color: var(--card-bg); border-color: var(--accent-color); }
    .mls-cup-card h4 { color: var(--text-color); }
    .bracket-round h4 { color: var(--text-color); opacity: 0.8; }
    .bracket-container { background-color: var(--bg-color); border: 1px solid var(--card-border); }
    
    /* Existing Styles */
    /* Bracket Styles */
    .bracket-container {
      display: flex;
      flex-direction: column;
      gap: 40px;
      overflow-x: auto;
      padding: 10px;
      border-radius: 8px;
    }
    .conference-section {
      margin-bottom: 20px;
    }
    .conference-title {
      text-align: center;
      margin-bottom: 15px;
      background: #333;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      font-weight: bold;
    }
    .bracket-tree {
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    .bracket-round {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      flex: 1;
      min-width: 160px;
    }
    .bracket-round h4 {
      text-align: center;
      font-size: 0.85rem;
      margin: 0 0 10px 0;
      text-transform: uppercase;
    }
    .match-card {
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 8px 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      font-size: 0.85rem;
    }
    .match-card .match-title {
      font-size: 0.7rem;
      color: #999;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    .match-card .team {
      padding: 3px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
    }
    .match-card .team:last-child {
      border-bottom: none;
    }
    .match-card .team.winner {
      font-weight: bold;
      color: var(--accent-color);
    }
    .match-card .team.winner::after {
      content: '‚úì';
      margin-left: 5px;
      font-size: 0.8em;
    }
    .mls-cup-container {
      border-top: 4px solid #333;
      padding-top: 20px;
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
    .mls-cup-card {
      border: 2px solid var(--accent-color);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      min-width: 280px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .mls-cup-card h4 { margin: 0 0 10px 0; }
    .mls-cup-winner { 
      font-size: 1.3rem; 
      font-weight: bold; 
      color: var(--accent-color); 
      margin-top: 10px; 
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: 1px solid var(--text-color);
      color: var(--text-color);
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    /* Player Tab Styles */
    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .player-card {
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      transition: transform 0.2s;
    }
    .player-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .player-avatar {
      font-size: 3rem;
      margin-bottom: 10px;
    }
    .player-name { font-weight: bold; margin-bottom: 5px; color: var(--text-color); }
    .player-team { font-size: 0.85rem; color: #777; margin-bottom: 10px; }
    .player-stat-badge { background: #eee; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-block; }
    body.dark-mode .player-stat-badge { background: #333; color: #eee; }

    /* H2H Styles */
    .h2h-container { display: flex; gap: 20px; flex-wrap: wrap; }
    .h2h-col { flex: 1; min-width: 250px; }
    .stat-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--card-border); }
    .stat-label { font-weight: bold; color: #777; }
    .stat-val { font-weight: bold; }
    
    /* Prediction League Styles */
    .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .leaderboard-table th, .leaderboard-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--card-border); }
    .prediction-card { border: 1px solid var(--card-border); padding: 10px; margin-bottom: 10px; border-radius: 6px; }
    .pred-options { display: flex; gap: 10px; margin-top: 5px; }
    .pred-btn { padding: 5px 10px; border: 1px solid #ccc; background: var(--card-bg); cursor: pointer; border-radius: 4px; }
    .pred-btn.selected { background: var(--accent-color); color: white; border-color: var(--accent-color); }
    .points-badge { background: #ffd700; color: #333; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }

    /* Notifications */
    .notification-area {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .notification {
        background: #333;
        color: #fff;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }
  </style>
</head>
<body>
  <main class="page">
    <div id="notification-area" class="notification-area"></div>
    <button id="theme-toggle" class="theme-toggle">üåô Dark Mode</button>
    <div class="home-logo-wrap">
      <a href="/" style="text-decoration: none; display: flex; align-items: center; gap: 8px; color: var(--text-color); font-weight: bold; font-size: 1.2rem;" aria-label="Home">
        <span style="background: var(--accent-color); color: #fff; padding: 4px 8px; border-radius: 4px;">SP</span>
        <span>Home</span>
      </a>
    </div>
    <h1>Soccer Predictor</h1>
    <p class="sub">Use tabs for predictors, upcoming picks, and projected league tables.</p>

    <div class="tabs">
      <button id="tab-home" class="tab-btn active" type="button">Home</button>
      <button id="tab-predictor" class="tab-btn" type="button">Predictor (European Leagues)</button>
      <button id="tab-global" class="tab-btn" type="button">Upcoming Matches</button>
      <button id="tab-h2h" class="tab-btn" type="button">Head to Head</button>
      <button id="tab-league" class="tab-btn" type="button">Prediction League</button>
      <button id="tab-market" class="tab-btn" type="button">Market & Odds</button>
      <button id="tab-league-table" class="tab-btn" type="button">League Table</button>
      <button id="tab-players" class="tab-btn" type="button">Players (Coming Soon)</button>
      <button id="tab-tactics" class="tab-btn" type="button">Tactics Board</button>
      <button id="tab-about" class="tab-btn" type="button">About</button>
    </div>

    <section id="panel-home">
      <div class="card">
        <h3>Welcome</h3>
        <p>
          This is your soccer prediction dashboard for European leagues and MLS.
          Use the tabs to run single-match predictions, review upcoming fixtures, and view projected tables.
        </p>
      </div>
      <div class="card">
        <h3>Quick Navigation</h3>
        <p>
          Start with <strong>Predictor</strong> for one matchup, <strong>Upcoming Matches</strong> for matchweek picks,
          or <strong>League Table</strong> for season projections.
        </p>
      </div>
    </section>

    <section id="panel-predictor" class="hidden">
      <div class="tabs">
        <button id="subtab-predictor-euro" class="tab-btn active" type="button">European</button>
        <button id="subtab-predictor-mls" class="tab-btn" type="button">MLS</button>
      </div>

      <section id="predictor-euro-body">
        <form id="predict-form" class="card">
          <label for="home-team">Home Team</label>
          <input id="home-team" name="home_team" list="teams" required placeholder="Start typing team name">

          <label for="away-team">Away Team</label>
          <input id="away-team" name="away_team" list="teams" required placeholder="Start typing team name">

          <datalist id="teams">
            {% for team in teams %}
            <option value="{{ team }}"></option>
            {% endfor %}
          </datalist>

          <button type="submit">Predict</button>
        </form>

        <section id="result" class="card hidden"></section>
        <section class="card">
          <p class="note">Disclaimer: predictions between different leagues are often far less accurate. Use for entertainment purposes only.</p>
        </section>
        <section id="error" class="card error hidden"></section>
      </section>

      <section id="predictor-mls-body" class="hidden">
        <form id="predict-form-mls" class="card">
          <label for="home-team-mls">Home Team (MLS)</label>
          <input id="home-team-mls" name="home_team" list="mls-teams" required placeholder="Start typing MLS team name">

          <label for="away-team-mls">Away Team (MLS)</label>
          <input id="away-team-mls" name="away_team" list="mls-teams" required placeholder="Start typing MLS team name">

          <datalist id="mls-teams">
            {% for team in mls_teams %}
            <option value="{{ team }}"></option>
            {% endfor %}
          </datalist>

          <button type="submit">Predict MLS</button>
        </form>

        <section class="card">
          <p class="note">Disclaimer: MLS data is currently limited and predictions may be less accurate. These predictions are likely to be less accurate than 
          European league predictions. Use for entertainment purposes only.
          </p>
        </section>
        <section id="result-mls" class="card hidden"></section>
        <section id="error-mls" class="card error hidden"></section>
      </section>
    </section>

    <section id="panel-global" class="hidden">
      <div id="global-stats" class="card"></div>
      <div class="card">
        <label for="global-source-filter">Source</label>
        <select id="global-source-filter">
          <option value="global">European Leagues</option>
          <option value="mls">MLS</option>
        </select>
      </div>
      <div class="card">
        <label for="global-league-filter">League</label>
        <select id="global-league-filter"></select>
      </div>
      <div id="global-list" class="card">Loading...</div>
    </section>

    <section id="panel-h2h" class="hidden">
      <div class="card">
        <h3>Head to Head Comparison</h3>
        <div class="controls" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
            <div style="flex: 1;">
                <label for="h2h-team1">Team 1</label>
                <input id="h2h-team1" list="teams" placeholder="Type team name..." style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); color: var(--text-color);">
            </div>
            <div style="flex: 1;">
                <label for="h2h-team2">Team 2</label>
                <input id="h2h-team2" list="teams" placeholder="Type team name..." style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); color: var(--text-color);">
            </div>
            <button id="btn-compare" class="tab-btn active" type="button" style="margin: 0; height: 38px;">Compare</button>
        </div>
      </div>
      <div id="h2h-results" class="hidden">
          <!-- Results injected here -->
      </div>
    </section>

    <section id="panel-league" class="hidden">
      <div class="card">
        <h3>Prediction League</h3>
        <p>Compete against the AI! Predict the outcome of upcoming matches.</p>
        <div style="margin-bottom: 15px;">
            <label>Your Name: <input id="league-username" type="text" placeholder="Enter name" style="padding: 5px; border-radius: 4px; border: 1px solid var(--card-border); background: var(--card-bg); color: var(--text-color);"></label>
            <span id="user-points" style="margin-left: 10px; font-weight: bold;">Points: 0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
          <div class="card" style="flex: 2; min-width: 300px;">
              <h4>Upcoming Fixtures to Predict</h4>
              <div id="league-fixtures">Loading fixtures...</div>
          </div>
          <div class="card" style="flex: 1; min-width: 250px;">
              <h4>Leaderboard</h4>
              <table class="leaderboard-table">
                  <thead><tr><th>Rank</th><th>User</th><th>Points</th></tr></thead>
                  <tbody id="leaderboard-body">
                      <!-- Mock Data -->
                  </tbody>
              </table>
          </div>
      </div>
    </section>

    <section id="panel-market" class="hidden">
      <div class="card">
        <h3>Prediction Market & Betting Odds</h3>
        <p>Current estimates and betting odds will appear here.</p>
      </div>
    </section>

    <section id="panel-league-table" class="hidden">
      <div class="card">
        <h3>Projected League Table</h3>
        <div class="table-controls">
          <label for="table-dataset">Dataset</label>
          <select id="table-dataset">
            <option value="global">European Leagues</option>
            <option value="mls">MLS</option>
          </select>

          <label for="table-league">League</label>
          <select id="table-league"></select>
        </div>
      </div>
      <div id="league-table-view" class="card">Select a dataset and league.</div>
    </section>

    <section id="panel-players" class="hidden">
      <div class="card">
        <h3>Player Database (Preview)</h3>
        <div class="controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="player-search" placeholder="Search for a player..." style="flex: 1; padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); color: var(--text-color);">
            <select id="player-league-filter" style="padding: 8px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); color: var(--text-color);">
                <option value="all">All Leagues</option>
                <option value="premier">Premier League</option>
                <option value="laliga">La Liga</option>
                <option value="mls">MLS</option>
            </select>
            <button class="tab-btn active" type="button" style="margin: 0;">Search</button>
        </div>
        
        <div class="player-grid">
            <p style="grid-column: 1/-1; text-align: center; color: #777;">No player data loaded.</p>
        </div>
        <p class="note" style="margin-top: 20px;">* This is a preview of the upcoming player database feature.</p>
      </div>
    </section>

    <section id="panel-about" class="hidden">
      <div class="card">
        <h3>About This Project</h3>
        <p>
          This app predicts soccer match outcomes using historical match data, team-level form/stat features,
          and model-generated probabilities. It supports many popular European leagues and the MLS with more leagues to come
          in the future. The models include specific tuning to different leagues to improve accuracy. This website is created as 
          a fun personal project to explore machine learning and data analysis and should not be used for any betting, financial, 
          or professional purposes. Predictions are not guaranteed to be accurate and are likely highly inaccurate.
        </p>
      </div>
      <div class="card">
        <h3>How To Use It</h3>
        <p>
          The predictor tool allows for match predictions between teams in the currently supported European leagues (Premier League,
           Championship, Bundesliga, Ligue 1, La Liga, Serie A, etc.). The separate MLS predictor only works with MLS matchups and uses a 
           sepearate, less advanced model due to current data limitations. Predictions between teams in different leagues often create wild
           predictions and are far less accurate than predictions of teams in the same league. The upcoming matches tab is used to show matches
           of the current matchweek (and midweek fixtures), but do not include cup competitions (including the Champions League). Each prediction
           also includes a score prediction and may include shots and shot on target predictions and a reasoning for the match prediction. These additional
           features are experimental and may not be available for all matches or leagues. The league table shows the predicted league table based on real 
           results and predicted results for the rest of the season. Accuracy of the predictions is not guaranteed and should be used for ENTERTAINMENT PURPOSES ONLY.
        </p>
      </div>
      <div class = "card">
        <h3>Upcoming Features & Improvements</h3>
        <p>
          <ul>
            <li><strong>Advanced Metrics (xG):</strong> Integrating Expected Goals and other advanced stats to reduce variance in predictions.</li>
            <li><strong>Live Match Tracker:</strong> Real-time score updates and prediction status tracking.</li>
            <li><strong>User Accounts:</strong> Save your tactics, prediction history, and join private leagues.</li>
            <li><strong>Tactics Simulation:</strong> Simple physics-based simulation to test formations on the whiteboard.</li>
            <li><strong>Multi-Sport Support:</strong> Expanding the platform to NBA and NFL predictions.</li>
            <li><strong>Historical Archive:</strong> Searchable database of past model performance and match results.</li>
            <li><strong>Squad Depth Analysis:</strong> Using Transfermarkt data to adjust for injuries and suspensions.</li>
          </ul>
        </p>
      </div>
      <div class="card">
        <h3>Feedback</h3>
        <p>Have an idea or found a bug? Let us know!</p>
        <textarea id="feedback-text" placeholder="Type your feedback here..." style="width: 100%; padding: 10px; border: 1px solid var(--card-border); border-radius: 4px; background: var(--card-bg); color: var(--text-color); margin-bottom: 10px; min-height: 80px;"></textarea>
        <button class="tab-btn active" type="button" onclick="showNotification('Feedback sent! Thank you.')" style="margin: 0;">Send Feedback</button>
      </div>
    </section>
    <section>
    <div class = "card">
        <h3>Known Bugs & Issues</h3>
        <p>
          <ul>
            <li>
              Some team matchups may be missing or duplicated in the upcoming matches tab
            </li>
            <li>
              Match prediction live correct/incorrect trackers is not stable and may be inaccurate or not update properly
            </li>
            <li>
              Many predictions may lack reasoning or additional data
            </li>
            <li>
              The model may have some inaccuracies due to data filtering limitations and often has wilder prediction
              percentages compared to other prediction models
            </li>
            <li>
              Some functions of the website may not function properly
            </li>
          </ul>
        </p>
    </section>
    <section class="card disclaimer">
      <h3>Disclaimer</h3>
      <p>
        These predictions are model-generated estimates for entertainment use only.
        Results are not guaranteed, and probabilities can change as data updates. 
        This is a project made for fun and should not be relied upon for any professional, betting, or financial decisions.

      </p>
      <p>

        DO NOT treat this as betting, financial, or professional advice in any aspect.

      </p>
      <p>

        Historical result data is sourced from football-data.co.uk. Realtime data is sourced from api.football-data.org, ESPN scoreboard, and Transfermarkt.com

      </p>
    </section>
  </main>

  <script>
    const form = document.getElementById("predict-form");
    const formMls = document.getElementById("predict-form-mls");
    const resultEl = document.getElementById("result");
    const errorEl = document.getElementById("error");
    const resultMlsEl = document.getElementById("result-mls");
    const errorMlsEl = document.getElementById("error-mls");
    const panelHome = document.getElementById("panel-home");
    const panelPredictor = document.getElementById("panel-predictor");
    const predictorEuroBody = document.getElementById("predictor-euro-body");
    const predictorMlsBody = document.getElementById("predictor-mls-body");
    const panelGlobal = document.getElementById("panel-global");
    const panelLeagueTable = document.getElementById("panel-league-table");
    const panelPlayers = document.getElementById("panel-players");
    const panelAbout = document.getElementById("panel-about");
    const tabHome = document.getElementById("tab-home");
    const tabPredictor = document.getElementById("tab-predictor");
    const subtabPredictorEuro = document.getElementById("subtab-predictor-euro");
    const subtabPredictorMls = document.getElementById("subtab-predictor-mls");
    const tabGlobal = document.getElementById("tab-global");
    const tabH2H = document.getElementById("tab-h2h");
    const tabLeague = document.getElementById("tab-league");
    const tabMarket = document.getElementById("tab-market");
    const tabLeagueTable = document.getElementById("tab-league-table");
    const tabPlayers = document.getElementById("tab-players");
    const tabTactics = document.getElementById("tab-tactics");
    const tabAbout = document.getElementById("tab-about");
    const globalList = document.getElementById("global-list");
    const globalStats = document.getElementById("global-stats");
    const globalSourceFilter = document.getElementById("global-source-filter");
    const globalLeagueFilter = document.getElementById("global-league-filter");
    const tableDataset = document.getElementById("table-dataset");
    const tableLeague = document.getElementById("table-league");
    const leagueTableView = document.getElementById("league-table-view");
    const panelH2H = document.getElementById("panel-h2h");
    const panelLeague = document.getElementById("panel-league");
    const panelMarket = document.getElementById("panel-market");
    const h2hResults = document.getElementById("h2h-results");
    const leagueFixtures = document.getElementById("league-fixtures");
    const leagueTablesCache = { global: null, mls: null };
    const upcomingCache = { global: [], mls: [] };
    const upcomingStatsCache = {
      global: { stats: null, league_stats: [] },
      mls: { stats: null, league_stats: [] },
    };
    
    // Dark Mode Logic
    const themeToggle = document.getElementById("theme-toggle");
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      themeToggle.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark-mode");
      themeToggle.textContent = "‚òÄÔ∏è Light Mode";
    }

    function showNotification(message) {
      const area = document.getElementById('notification-area');
      const el = document.createElement('div');
      el.className = 'notification';
      el.textContent = message;
      area.appendChild(el);
      setTimeout(() => {
        el.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => el.remove(), 300);
      }, 3000);
    }

    function showError(targetError, targetResult, message) {
      targetError.textContent = message;
      targetError.classList.remove("hidden");
      targetResult.classList.add("hidden");
    }

    function pctLabel(value) {
      const n = Number(value);
      if (!Number.isFinite(n)) return "0";
      if (n > 0 && n < 1) return "<1";
      return n.toFixed(1);
    }

    function showResult(targetError, targetResult, p, includeShots = true) {
      targetError.classList.add("hidden");
      targetResult.classList.remove("hidden");
      let html = `
        <h2>${p.home_team} vs ${p.away_team}</h2>
        <p><strong>Competition:</strong> ${p.competition}</p>
        <p>Winner: <span class="winner-line">${p.winner_label}</span></p>
        
        <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px;">
                <span>${p.home_team} (${pctLabel(p.prob_home)}%)</span>
                <span>Draw (${pctLabel(p.prob_draw)}%)</span>
                <span>${p.away_team} (${pctLabel(p.prob_away)}%)</span>
            </div>
            <div style="display: flex; height: 12px; width: 100%; border-radius: 6px; overflow: hidden; background: #eee;">
                <div style="width: ${p.prob_home}%; background-color: #4caf50;" title="${p.home_team}"></div>
                <div style="width: ${p.prob_draw}%; background-color: #9e9e9e;" title="Draw"></div>
                <div style="width: ${p.prob_away}%; background-color: #f44336;" title="${p.away_team}"></div>
            </div>
        </div>

        <p><strong>Predicted score:</strong> ${p.home_team} ${p.pred_home_goals} - ${p.pred_away_goals} ${p.away_team}</p>
      `;
      if (includeShots) {
        html += `
          <p><strong>Predicted shots:</strong> ${p.home_team} ${p.pred_home_shots} | ${p.away_team} ${p.pred_away_shots}</p>
          <p><strong>Predicted shots on target:</strong> ${p.home_team} ${p.pred_home_sot} | ${p.away_team} ${p.pred_away_sot}</p>
        `;
      }
      targetResult.innerHTML = html;
    }

    function activateTab(tab) {
      tabHome.classList.remove("active");
      tabPredictor.classList.remove("active");
      tabGlobal.classList.remove("active");
      tabH2H.classList.remove("active");
      tabLeague.classList.remove("active");
      tabMarket.classList.remove("active");
      tabLeagueTable.classList.remove("active");
      tabPlayers.classList.remove("active");
      tabAbout.classList.remove("active");
      panelHome.classList.add("hidden");
      panelPredictor.classList.add("hidden");
      panelGlobal.classList.add("hidden");
      panelH2H.classList.add("hidden");
      panelLeague.classList.add("hidden");
      panelMarket.classList.add("hidden");
      panelLeagueTable.classList.add("hidden");
      panelPlayers.classList.add("hidden");
      panelAbout.classList.add("hidden");

      if (tab === "home") {
        tabHome.classList.add("active");
        panelHome.classList.remove("hidden");
      } else if (tab === "predictor") {
        tabPredictor.classList.add("active");
        panelPredictor.classList.remove("hidden");
      } else if (tab === "global") {
        tabGlobal.classList.add("active");
        panelGlobal.classList.remove("hidden");
      } else if (tab === "h2h") {
        tabH2H.classList.add("active");
        panelH2H.classList.remove("hidden");
      } else if (tab === "league") {
        tabLeague.classList.add("active");
        panelLeague.classList.remove("hidden");
      } else if (tab === "market") {
        tabMarket.classList.add("active");
        panelMarket.classList.remove("hidden");
      } else if (tab === "league-table") {
        tabLeagueTable.classList.add("active");
        panelLeagueTable.classList.remove("hidden");
      } else if (tab === "players") {
        tabPlayers.classList.add("active");
        panelPlayers.classList.remove("hidden");
      } else if (tab === "about") {
        tabAbout.classList.add("active");
        panelAbout.classList.remove("hidden");
      } else {
        tabHome.classList.add("active");
        panelHome.classList.remove("hidden");
      }
    }

    function setPredictorMode(mode) {
      if (mode === "mls") {
        subtabPredictorEuro.classList.remove("active");
        subtabPredictorMls.classList.add("active");
        predictorEuroBody.classList.add("hidden");
        predictorMlsBody.classList.remove("hidden");
      } else {
        subtabPredictorMls.classList.remove("active");
        subtabPredictorEuro.classList.add("active");
        predictorMlsBody.classList.add("hidden");
        predictorEuroBody.classList.remove("hidden");
      }
    }

    function normalizeLeagueName(name) {
      return String(name || "").toLowerCase().replace(/\s+/g, " ").trim();
    }

    function getLeagueRowClass(leagueName, position, maxPos) {
      const league = normalizeLeagueName(leagueName);
      const isMlsSupporters = league === "united states/mls - supporters shield table";
      const isMlsEast = league === "united states/mls - eastern conference";
      const isMlsWest = league === "united states/mls - western conference";

      if (isMlsEast || isMlsWest) {
        if (position >= 1 && position <= 9) {
          return "table-promo-blue";
        }
        return "";
      }

      if (position === 1) {
        return "table-first";
      }

      const isBundesliga = league === "germany/bundesliga";
      const isLigue1 = league === "france/ligue 1";
      const isChampionship = league === "england/championship";
      const isLaLiga2 = league === "spain/la liga 2";
      const isSerieB = league === "italy/serie b";
      const isBundesliga2 = league === "germany/bundesliga 2" || league === "germany/2. bundesliga";
      const isLigue2 = league === "france/ligue 2";
      const isLigaPortugal = league === "portugal/liga portugal";
      const isPremier = league === "england/premier league";
      const isLaLiga = league === "spain/la liga";
      const isBundesligaTop = league === "germany/bundesliga";
      const isSerieA = league === "italy/serie a";

      if (isBundesliga || isLigue1) {
        if (position === 2 || position === 3) {
          return "table-promo-blue";
        }
        if (position === 4) {
          return "table-playoff-purple";
        }
        if (position === Math.max(1, maxPos - 2)) {
          return "table-playoff-orange";
        }
        if (position >= Math.max(1, maxPos - 1)) {
          return "table-bottom";
        }
        return "";
      }

      if (isChampionship) {
        if (position === 2) {
          return "table-promo-blue";
        }
        if (position >= 3 && position <= 6) {
          return "table-playoff-purple";
        }
      }

      if (isSerieB) {
        if (position === 2) {
          return "table-promo-blue";
        }
        if (position >= 3 && position <= 8) {
          return "table-playoff-purple";
        }
      }

      if (isLaLiga2) {
        if (position === 2) {
          return "table-promo-blue";
        }
        if (position >= 3 && position <= 6) {
          return "table-playoff-purple";
        }
      }

      if (isBundesliga2 || isLigue2) {
        if (position === 2) {
          return "table-promo-blue";
        }
        if (isLigue2 && position >= 3 && position <= 5) {
          return "table-playoff-purple";
        }
        if (!isLigue2 && position === 3) {
          return "table-playoff-purple";
        }
      }

      if (isLigaPortugal) {
        if (position === 2) {
          return "table-second-pink";
        }
        if (position === Math.max(1, maxPos - 2)) {
          return "table-playoff-orange";
        }
        if (position >= Math.max(1, maxPos - 1)) {
          return "table-bottom";
        }
      }

      if (isPremier || isLaLiga || isSerieA) {
        if (position >= 2 && position <= 4) {
          return "table-promo-blue";
        }
        if (position === 5) {
          return "table-playoff-purple";
        }
      }

      if (isMlsSupporters) {
        return "";
      }

      if (isLaLiga2) {
        if (position >= Math.max(1, maxPos - 3)) {
          return "table-bottom";
        }
      } else if (position >= Math.max(1, maxPos - 2)) {
        return "table-bottom";
      }

      return "";
    }

    function renderLeagueTableRows(rows, leagueName) {
      if (!rows || !rows.length) {
        return "<p>No projected table data available for this league.</p>";
      }
      const sortedRows = [...rows].sort((a, b) => (a.position || 0) - (b.position || 0));
      const maxPos = sortedRows.length;
      let html = `
        <table class="league-table">
          <thead>
            <tr>
              <th>Pos</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th>
              <th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
            </tr>
          </thead>
          <tbody>
      `;
      for (const r of sortedRows) {
        const rowClass = getLeagueRowClass(leagueName, r.position, maxPos);
        html += `
          <tr class="${rowClass}">
            <td>${r.position}</td><td>${r.team}</td><td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td>
            <td>${r.GF}</td><td>${r.GA}</td><td>${r.GD}</td><td><strong>${r.Pts}</strong></td>
          </tr>
        `;
      }
      html += "</tbody></table>";
      return html;
    }

    function renderSelectedLeagueTable() {
      const mode = tableDataset.value;
      const selectedLeague = tableLeague.value;
      const payload = leagueTablesCache[mode];
      if (!payload || !payload.tables || !payload.tables[selectedLeague]) {
        leagueTableView.innerHTML = "<p>No projected table data available.</p>";
        return;
      }
      leagueTableView.innerHTML = `<h3>${selectedLeague}</h3>${renderLeagueTableRows(payload.tables[selectedLeague], selectedLeague)}`;
    }

    function seedAt(rows, seed) {
      const row = (rows || []).find((r) => Number(r.position) === Number(seed));
      return row ? row.team : `Seed ${seed}`;
    }

    function renderMlsBracket(payload) {
      const bracket = payload ? payload.bracket : null;
      if (!bracket) {
        leagueTableView.innerHTML = "<p>No projected MLS playoff bracket found. Run MLS Project_League_Table.py first.</p>";
        return;
      }

      const eastSeeds = bracket.eastern_seeds || [];
      const westSeeds = bracket.western_seeds || [];
      const eastBySeed = {};
      const westBySeed = {};
      for (const row of eastSeeds) eastBySeed[Number(row.seed)] = row.team;
      for (const row of westSeeds) westBySeed[Number(row.seed)] = row.team;

      const getSeed = (teamName, conf) => {
          const map = conf === 'east' ? eastSeeds : westSeeds;
          const found = map.find(r => r.team === teamName);
          return found ? found.seed : '';
      };

      const renderMatch = (title, home, away, winner, conf) => {
          const homeSeed = getSeed(home, conf);
          const awaySeed = getSeed(away, conf);
          const homeClass = home === winner ? "winner" : "";
          const awayClass = away === winner ? "winner" : "";
          return `
            <div class="match-card">
                <div class="match-title">${title}</div>
                <div class="team ${homeClass}"><span>${homeSeed ? '#' + homeSeed + ' ' : ''}${home}</span></div>
                <div class="team ${awayClass}"><span>${awaySeed ? '#' + awaySeed + ' ' : ''}${away}</span></div>
            </div>
          `;
      };

      const wc = bracket.wildcard || {};
      const r1 = bracket.round_one || {};
      const sf = bracket.conference_semifinals || {};
      const cf = bracket.conference_finals || {};
      const cup = bracket.mls_cup || {};

      const eWC = wc.east || {};
      const eR1 = r1.east || {};
      const eSF = sf.east || [];
      const eCF = cf.east || {};

      const wWC = wc.west || {};
      const wR1 = r1.west || {};
      const wSF = sf.west || [];
      const wCF = cf.west || {};

      let html = `
        <h3>MLS Cup Playoff Bracket (Projected)</h3>
        <p class="note">Projected based on current standings and model probabilities.</p>
        <div class="bracket-container">
      `;

      const buildConfBracket = (name, confCode, wcMatch, r1Matches, sfMatches, cfMatch) => {
          return `
            <div class="conference-section">
                <div class="conference-title">${name} Conference</div>
                <div class="bracket-tree">
                    <div class="bracket-round">
                        <h4>Wildcard</h4>
                        ${renderMatch("Wildcard", wcMatch.home_team, wcMatch.away_team, wcMatch.winner, confCode)}
                    </div>
                    <div class="bracket-round">
                        <h4>Round One</h4>
                        ${renderMatch("Best of 3", r1Matches.A.high_seed_team, r1Matches.A.low_seed_team, r1Matches.A.winner, confCode)}
                        ${renderMatch("Best of 3", r1Matches.D.high_seed_team, r1Matches.D.low_seed_team, r1Matches.D.winner, confCode)}
                        ${renderMatch("Best of 3", r1Matches.B.high_seed_team, r1Matches.B.low_seed_team, r1Matches.B.winner, confCode)}
                        ${renderMatch("Best of 3", r1Matches.C.high_seed_team, r1Matches.C.low_seed_team, r1Matches.C.winner, confCode)}
                    </div>
                    <div class="bracket-round">
                        <h4>Semis</h4>
                        ${renderMatch("Semis", sfMatches[0].home_team, sfMatches[0].away_team, sfMatches[0].winner, confCode)}
                        ${renderMatch("Semis", sfMatches[1].home_team, sfMatches[1].away_team, sfMatches[1].winner, confCode)}
                    </div>
                    <div class="bracket-round">
                        <h4>Conf. Final</h4>
                        ${renderMatch("Final", cfMatch.home_team, cfMatch.away_team, cfMatch.winner, confCode)}
                    </div>
                </div>
            </div>
          `;
      };

      html += buildConfBracket("Eastern", "east", eWC, eR1, eSF, eCF);
      html += buildConfBracket("Western", "west", wWC, wR1, wSF, wCF);

      html += `
        <div class="mls-cup-container">
            <div class="mls-cup-card">
                <h4>MLS Cup Final</h4>
                <div class="team ${cup.home_team === cup.winner ? 'winner' : ''}">${cup.home_team}</div>
                <div class="team ${cup.away_team === cup.winner ? 'winner' : ''}">${cup.away_team}</div>
                <div class="mls-cup-winner">üèÜ ${cup.winner}</div>
            </div>
        </div>
      `;

      html += `</div>`;
      leagueTableView.innerHTML = html;
    }

    async function loadLeagueTables(mode) {
      leagueTableView.textContent = "Loading...";
      const resp = await fetch(`/api/league-tables?mode=${encodeURIComponent(mode)}`);
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        leagueTableView.textContent = "Failed to load league tables.";
        return;
      }
      leagueTablesCache[mode] = data;
      const leagues = data.leagues || [];
      tableLeague.innerHTML = "";
      if (!leagues.length) {
        leagueTableView.innerHTML = "<p>No projected table CSV found. Run Project_League_Table.py first.</p>";
        return;
      }
      const priorityLeagues = [
        "England/Premier League",
        "England/Championship",
        "United States/MLS - Supporters Shield Table",
        "United States/MLS - Eastern Conference",
        "United States/MLS - Western Conference"
      ];
      const leagueRank = (name) => {
        const idx = priorityLeagues.indexOf(name);
        return idx >= 0 ? idx : 1000;
      };
      const orderedLeagues = [...leagues].sort((a, b) => {
        const ra = leagueRank(a);
        const rb = leagueRank(b);
        if (ra !== rb) return ra - rb;
        return a.localeCompare(b);
      });
      for (const league of orderedLeagues) {
        const option = document.createElement("option");
        option.value = league;
        option.textContent = league;
        tableLeague.appendChild(option);
      }
      if (mode === "mls") {
        const option = document.createElement("option");
        option.value = "__mls_bracket__";
        option.textContent = "MLS Cup Playoff Bracket";
        tableLeague.appendChild(option);
      }
      if (mode === "mls" && tableLeague.value === "__mls_bracket__") {
        await renderMlsBracket(data);
      } else {
        renderSelectedLeagueTable();
      }
    }

    function renderLeagueStats(leagueStats, selectedLeague) {
      if (!selectedLeague || !leagueStats || !leagueStats.length) {
        return "<p>No selected league stats yet.</p>";
      }
      const row = leagueStats.find((item) => item.competition === selectedLeague);
      if (!row) {
        return "<p>No selected league stats yet.</p>";
      }
      return `<p><strong>${row.competition} Accuracy:</strong> ${row.correct_total}/${row.settled_total} (${row.accuracy_pct}%)</p>`;
    }

    function renderStats(target, stats, leagueStats, selectedLeague) {
      target.innerHTML = `
        <h3>Tracking Stats</h3>
        <p><strong>Correct / Decided:</strong> ${stats.correct_total} / ${stats.settled_total}</p>
        <p><strong>Accuracy:</strong> ${stats.accuracy_pct}%</p>
        <p><strong>Decided:</strong> ${stats.settled_total} | <strong>Pending:</strong> ${stats.pending_total}</p>
        ${renderLeagueStats(leagueStats, selectedLeague)}
      `;
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderUpcoming(target, rows, selectedLeague) {
      if (!rows.length) {
        target.innerHTML = "<p>No upcoming predictions found.</p>";
        return;
      }
      const visibleRows = selectedLeague ? rows.filter((r) => r.competition === selectedLeague) : rows;
      if (!visibleRows.length) {
        target.innerHTML = "<p>No upcoming predictions for this league.</p>";
        return;
      }
      const byDay = {};
      for (const r of visibleRows) {
        const key = `${r.weekday} ${r.date_label}`;
        byDay[key] = byDay[key] || [];
        byDay[key].push(r);
      }
      const days = Object.keys(byDay);
      let html = "";
      let idx = 0;
      for (const day of days) {
        html += `<h4>${day}</h4>`;
        for (const r of byDay[day]) {
          idx += 1;
          const detailId = `match-detail-${idx}`;
          const homeGoals = (r.pred_home_goals === null || r.pred_home_goals === undefined) ? "NA" : r.pred_home_goals;
          const awayGoals = (r.pred_away_goals === null || r.pred_away_goals === undefined) ? "NA" : r.pred_away_goals;
          const reasoning = r.reasoning && r.reasoning.trim().length
            ? escapeHtml(r.reasoning)
            : "No model reasoning available for this prediction.";
          const settled = String(r.actual_result || "").trim().match(/^[HDA]$/i);
          const isCorrect = String(r.is_correct || "").trim().toLowerCase();
          let rowClass = "";
          let statusText = "Pending";
          if (settled) {
            if (isCorrect === "1" || isCorrect === "true") {
              rowClass = "match-correct";
              statusText = "Correct";
            } else {
              rowClass = "match-wrong";
              statusText = "Wrong";
            }
          }
          html += `
            <div class="match-row ${rowClass}">
              <button class="match-toggle" type="button" data-target="${detailId}" aria-expanded="false">
                <div class="matchup">${r.home_team} vs ${r.away_team}</div>
                <div class="match-meta">Winner: <span class="winner-line">${r.winner_label}</span></div>
                ${r.time_label ? `<div class="match-meta"><strong>Kickoff:</strong> ${escapeHtml(r.time_label)}</div>` : ""}
                
                <div style="display: flex; height: 6px; width: 100%; border-radius: 3px; overflow: hidden; background: #eee; margin: 6px 0;">
                    <div style="width: ${r.prob_home}%; background-color: #4caf50;" title="${r.home_team}"></div>
                    <div style="width: ${r.prob_draw}%; background-color: #9e9e9e;" title="Draw"></div>
                    <div style="width: ${r.prob_away}%; background-color: #f44336;" title="${r.away_team}"></div>
                </div>
                <div class="match-meta" style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                    <span>H: ${r.prob_home_text || pctLabel(r.prob_home)}%</span> <span>D: ${r.prob_draw_text || pctLabel(r.prob_draw)}%</span> <span>A: ${r.prob_away_text || pctLabel(r.prob_away)}%</span>
                </div>

                <div class="match-meta"><strong>Status:</strong> ${statusText}</div>
              </button>
              <div id="${detailId}" class="match-details hidden">
                <div class="match-meta"><strong>Predicted score:</strong> ${r.home_team} ${homeGoals} - ${awayGoals} ${r.away_team}</div>
                <div class="match-meta"><strong>Reasoning:</strong> ${reasoning}</div>
              </div>
            </div>
          `;
        }
      }
      target.innerHTML = html;
    }

    function populateUpcomingLeagueFilter(selectEl, rows) {
      const leagues = [...new Set(rows.map((r) => r.competition))];
      const priorityLeagues = [
        "England/Premier League",
        "England/Championship"
      ];
      const leagueRank = (name) => {
        const idx = priorityLeagues.indexOf(name);
        return idx >= 0 ? idx : 1000;
      };
      leagues.sort((a, b) => {
        const ra = leagueRank(a);
        const rb = leagueRank(b);
        if (ra !== rb) return ra - rb;
        return a.localeCompare(b);
      });
      selectEl.innerHTML = "";
      if (!leagues.length) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No leagues";
        selectEl.appendChild(option);
        return "";
      }
      for (const league of leagues) {
        const option = document.createElement("option");
        option.value = league;
        option.textContent = league;
        selectEl.appendChild(option);
      }
      return leagues[0];
    }

    async function loadUpcoming(mode, url, target, statsTarget, filterEl) {
      target.textContent = "Loading...";
      statsTarget.textContent = "Loading...";
      const resp = await fetch(url);
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        target.textContent = "Failed to load upcoming predictions.";
        statsTarget.textContent = "Failed to load stats.";
        return;
      }
      const rows = data.rows || [];
      upcomingCache[mode] = rows;
      const stats = data.stats || {
        correct_total: 0, settled_total: 0, accuracy_pct: 0.0, total_predictions: 0, pending_total: 0
      };
      const leagueStats = data.league_stats || [];
      upcomingStatsCache[mode] = { stats: stats, league_stats: leagueStats };
      const selectedLeague = populateUpcomingLeagueFilter(filterEl, rows);
      renderUpcoming(target, rows, selectedLeague);
      renderStats(statsTarget, stats, leagueStats, selectedLeague);
    }

    // H2H Logic
    document.getElementById("btn-compare").addEventListener("click", async () => {
        const t1 = document.getElementById("h2h-team1").value;
        const t2 = document.getElementById("h2h-team2").value;
        if(!t1 || !t2) return showNotification("Please select two teams.");
        
        h2hResults.innerHTML = "Loading...";
        h2hResults.classList.remove("hidden");
        
        try {
            const resp = await fetch(`/api/h2h?team1=${encodeURIComponent(t1)}&team2=${encodeURIComponent(t2)}`);
            const data = await resp.json();
            if(!data.ok) throw new Error(data.error);
            
            const s1 = data.team1_stats || {};
            const s2 = data.team2_stats || {};
            const f1 = data.team1_form || {};
            const f2 = data.team2_form || {};
            const h2h = data.h2h_data || {};
            const h2hRev = data.h2h_data_reverse || {};
            
            const renderStatRow = (label, v1, v2) => `
                <div class="stat-row">
                    <span class="stat-val">${v1 !== undefined ? v1 : '-'}</span>
                    <span class="stat-label">${label}</span>
                    <span class="stat-val">${v2 !== undefined ? v2 : '-'}</span>
                </div>`;

            h2hResults.innerHTML = `
                <div class="h2h-container">
                    <div class="h2h-col card">
                        <h3 style="text-align: center;">${t1}</h3>
                        ${renderStatRow("Matches Played", s1.games, s2.games)}
                        ${renderStatRow("Wins", s1.wins, s2.wins)}
                        ${renderStatRow("Losses", s1.losses, s2.losses)}
                        ${renderStatRow("Goals Scored", s1.goals_scored, s2.goals_scored)}
                        ${renderStatRow("Goals Conceded", s1.goals_conceded, s2.goals_conceded)}
                        ${renderStatRow("Avg Goals/Game", s1.avg_goals_scored, s2.avg_goals_scored)}
                        <h4 style="margin-top: 15px; text-align: center;">Recent Form (Last 10)</h4>
                        ${renderStatRow("Points", f1.points_last_10, f2.points_last_10)}
                        ${renderStatRow("Wins", f1.wins_last_10, f2.wins_last_10)}
                        ${renderStatRow("Goals For (Avg)", f1.avg_goals_for_last_10, f2.avg_goals_for_last_10)}
                    </div>
                    <div class="h2h-col card">
                        <h3>Head to Head History</h3>
                        <p><strong>${t1} vs ${t2}</strong></p>
                        <p>Matches Recorded: ${(h2h.games || 0) + (h2hRev.games || 0)}</p>
                        <div style="margin-top: 10px;">
                            <p>When ${t1} is Home:</p>
                            <ul>
                                <li>${t1} Wins: ${h2h.home_wins || 0}</li>
                                <li>Draws: ${h2h.home_draws || 0}</li>
                                <li>${t2} Wins: ${h2h.home_losses || 0}</li>
                            </ul>
                        </div>
                        <div style="margin-top: 10px;">
                            <p>When ${t2} is Home:</p>
                            <ul>
                                <li>${t2} Wins: ${h2hRev.home_wins || 0}</li>
                                <li>Draws: ${h2hRev.home_draws || 0}</li>
                                <li>${t1} Wins: ${h2hRev.home_losses || 0}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        } catch(e) {
            h2hResults.innerHTML = `<p class="error">Error: ${e.message}</p>`;
        }
    });

    // Prediction League Logic
    function loadLeagueFixtures() {
        // Use cached upcoming matches
        const matches = [...upcomingCache.global, ...upcomingCache.mls].slice(0, 10); // Limit to 10
        if(matches.length === 0) {
            leagueFixtures.innerHTML = "No upcoming matches available to predict.";
            return;
        }
        
        let html = "";
        matches.forEach((m, idx) => {
            const id = `pred-${idx}`;
            html += `
                <div class="prediction-card">
                    <div><strong>${m.home_team} vs ${m.away_team}</strong> <span style="font-size: 0.8em; color: #666;">(${m.competition})</span></div>
                    <div class="pred-options" data-match-id="${id}">
                        <button class="pred-btn" onclick="selectPrediction('${id}', 'H')">${m.home_team}</button>
                        <button class="pred-btn" onclick="selectPrediction('${id}', 'D')">Draw</button>
                        <button class="pred-btn" onclick="selectPrediction('${id}', 'A')">${m.away_team}</button>
                    </div>
                </div>
            `;
        });
        html += `<button class="tab-btn active" onclick="savePredictions()">Submit Predictions</button>`;
        leagueFixtures.innerHTML = html;
        
        // Load leaderboard
        const leaderboard = [];
        const tbody = document.getElementById("leaderboard-body");
        tbody.innerHTML = leaderboard.map(r => `<tr><td>${r.rank}</td><td>${r.user}</td><td>${r.points}</td></tr>`).join("");
    }
    
    window.selectPrediction = (id, val) => {
        const container = document.querySelector(`.pred-options[data-match-id="${id}"]`);
        container.querySelectorAll('.pred-btn').forEach(b => b.classList.remove('selected'));
        // Find button by text content or index is tricky, let's assume order H, D, A
        const idx = val === 'H' ? 0 : val === 'D' ? 1 : 2;
        container.children[idx].classList.add('selected');
        container.dataset.selection = val;
    };
    
    window.savePredictions = () => {
        const user = document.getElementById("league-username").value;
        if(!user) return showNotification("Please enter a username.");
        const preds = [];
        document.querySelectorAll('.pred-options').forEach(el => {
            if(el.dataset.selection) preds.push({id: el.dataset.matchId, pick: el.dataset.selection});
        });
        showNotification(`Submitted ${preds.length} predictions for ${user}! (This is a demo feature)`);
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const payload = {
        home_team: formData.get("home_team"),
        away_team: formData.get("away_team"),
      };

      const resp = await fetch("/api/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        showError(errorEl, resultEl, data.error || "Prediction failed.");
        return;
      }
      showResult(errorEl, resultEl, data.prediction);
    });

    formMls.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(formMls);
      const payload = {
        home_team: formData.get("home_team"),
        away_team: formData.get("away_team"),
      };

      const resp = await fetch("/api/predict/mls", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        showError(errorMlsEl, resultMlsEl, data.error || "MLS prediction failed.");
        return;
      }
      showResult(errorMlsEl, resultMlsEl, data.prediction, false);
    });

    tabHome.addEventListener("click", () => activateTab("home"));
    tabPredictor.addEventListener("click", () => activateTab("predictor"));
    subtabPredictorEuro.addEventListener("click", () => setPredictorMode("euro"));
    subtabPredictorMls.addEventListener("click", () => setPredictorMode("mls"));
    tabGlobal.addEventListener("click", async () => {
      activateTab("global");
      const source = globalSourceFilter.value === "mls" ? "mls" : "global";
      const url = source === "mls" ? "/api/upcoming/mls" : "/api/upcoming/global";
      await loadUpcoming(source, url, globalList, globalStats, globalLeagueFilter);
    });
    tabH2H.addEventListener("click", () => activateTab("h2h"));
    tabLeague.addEventListener("click", async () => {
        activateTab("league");
        if(upcomingCache.global.length === 0 && upcomingCache.mls.length === 0) {
            await loadUpcoming("global", "/api/upcoming/global", globalList, globalStats, globalLeagueFilter);
        }
        loadLeagueFixtures();
    });
    tabMarket.addEventListener("click", () => activateTab("market"));
    tabLeagueTable.addEventListener("click", async () => {
      activateTab("league-table");
      if (!leagueTablesCache[tableDataset.value]) {
        await loadLeagueTables(tableDataset.value);
      } else {
        const cached = leagueTablesCache[tableDataset.value];
        tableLeague.innerHTML = "";
        const priorityLeagues = [
          "England/Premier League",
          "England/Championship",
          "United States/MLS - Supporters Shield Table",
          "United States/MLS - Eastern Conference",
          "United States/MLS - Western Conference"
        ];
        const leagueRank = (name) => {
          const idx = priorityLeagues.indexOf(name);
          return idx >= 0 ? idx : 1000;
        };
        const orderedLeagues = [...(cached.leagues || [])].sort((a, b) => {
          const ra = leagueRank(a);
          const rb = leagueRank(b);
          if (ra !== rb) return ra - rb;
          return a.localeCompare(b);
        });
        for (const league of orderedLeagues) {
          const option = document.createElement("option");
          option.value = league;
          option.textContent = league;
          tableLeague.appendChild(option);
        }
        if (tableDataset.value === "mls") {
          const option = document.createElement("option");
          option.value = "__mls_bracket__";
          option.textContent = "MLS Cup Playoff Bracket";
          tableLeague.appendChild(option);
        }
        if (tableDataset.value === "mls" && tableLeague.value === "__mls_bracket__") {
          await renderMlsBracket(cached);
        } else {
          renderSelectedLeagueTable();
        }
      }
    });
    tabPlayers.addEventListener("click", () => activateTab("players"));
    tabTactics.addEventListener("click", () => {
      window.location.href = "/tactics";
    });
    tabAbout.addEventListener("click", () => activateTab("about"));
    tableDataset.addEventListener("change", async () => {
      await loadLeagueTables(tableDataset.value);
    });
    tableLeague.addEventListener("change", async () => {
      if (tableDataset.value === "mls" && tableLeague.value === "__mls_bracket__") {
        await renderMlsBracket(leagueTablesCache["mls"] || { tables: {} });
      } else {
        renderSelectedLeagueTable();
      }
    });
    globalLeagueFilter.addEventListener("change", () => {
      const source = globalSourceFilter.value === "mls" ? "mls" : "global";
      renderUpcoming(globalList, upcomingCache[source], globalLeagueFilter.value);
      const payload = upcomingStatsCache[source];
      renderStats(
        globalStats,
        payload.stats || { correct_total: 0, total_predictions: 0, pending_total: 0, accuracy_pct: 0.0 },
        payload.league_stats || [],
        globalLeagueFilter.value
      );
    });
    globalSourceFilter.addEventListener("change", async () => {
      const source = globalSourceFilter.value === "mls" ? "mls" : "global";
      const url = source === "mls" ? "/api/upcoming/mls" : "/api/upcoming/global";
      await loadUpcoming(source, url, globalList, globalStats, globalLeagueFilter);
    });

    globalList.addEventListener("click", (event) => {
      const btn = event.target.closest(".match-toggle");
      if (!btn) return;
      const targetId = btn.getAttribute("data-target");
      const detail = targetId ? document.getElementById(targetId) : null;
      if (!detail) return;
      const isHidden = detail.classList.contains("hidden");
      detail.classList.toggle("hidden");
      btn.setAttribute("aria-expanded", isHidden ? "true" : "false");
    });
  </script>
</body>
</html>
